xyplot(eval_post)
dev.off()
png("Figures/autocorr_post.png")
autocorr.plot(eval_post)
dev.off()
#Location stratified
png("Figures/xyplot_namerica.png")
xyplot(eval_namerica)
dev.off()
png("Figures/autocorr_namerica.png")
autocorr.plot(eval_namerica)
dev.off()
png("Figures/xyplot_europe.png")
xyplot(eval_europe)
dev.off()
png("Figures/autocorr_europe.png")
autocorr.plot(eval_europe)
dev.off()
#Sanatorium stratified
png("Figures/xyplot_yessan.png")
xyplot(eval_yessan)
dev.off()
png("Figures/autocorr_yessan.png")
autocorr.plot(eval_yessan)
dev.off()
png("Figures/xyplot_nosan.png")
xyplot(eval_nosan)
dev.off()
png("Figures/autocorr_nosan.png")
autocorr.plot(eval_nosan)
dev.off()
View(data_comb)
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data and analysis results
mortality <- read.csv("data/mortality_data.csv")
load('R/bayesian_raw.RData')
load('R/bayesian_clean.RData')
#### Table of Main Results -----------------------------------------------------
#Combining raw tables from results lists
raw_tab <- bind_rows(form_comb$param, form_pre$param, form_post$param,
form_namerica$param, form_europe$param, form_yessan$param,
form_nosan$param)
#Extracting the survival probabilities
pred1_tab <- raw_tab %>%
filter(value == "pred1") %>%
mutate(`1-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `1-Year Survival (95% CI)`)
pred5_tab <- raw_tab %>%
filter(value == "pred5") %>%
mutate(`5-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `5-Year Survival (95% CI)`)
pred10_tab <- raw_tab %>%
filter(value == "pred10") %>%
mutate(`10-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `10-Year Survival (95% CI)`)
#Extracting median survival
med_tab <- raw_tab %>%
filter(value == "median") %>%
mutate(`Median Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `Median Survival (95% CI)`)
#Extracting the distribution parameters
sdlog <- raw_tab %>%
filter(value == "sdlog") %>%
select(label, sdlog = est)
dist_tab <- raw_tab %>%
filter(value == "meanlog") %>%
full_join(sdlog, by = "label") %>%
mutate(`Survival Distribution` = paste0("lognormal(", round(est, 2), ", ",
round(sdlog, 2), ")")) %>%
select(label, `Survival Distribution`)
View(dist_tab)
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data
mortality <- read.csv("data/mortality_data.csv")
#Reading in analysis results
load("R/bayesian_raw.RData")
## Formatting results
form_comb <- formatBayesian(mortality, res_comb, data_comb, "Combined")
form_pre <- formatBayesian(mortality, res_pre, data_pre, "Pre-1930")
form_post <- formatBayesian(mortality, res_post, data_post, "Post-1930")
form_namerica <- formatBayesian(mortality, res_namerica, data_namerica, "North America")
form_europe <- formatBayesian(mortality, res_europe, data_europe, "Europe")
form_yessan <- formatBayesian(mortality, res_yessan, data_yessan, "Sanatorium/hospital")
form_nosan <- formatBayesian(mortality, res_nosan, data_nosan, "Non-Sanatorium")
## Saving results
save(form_comb, form_pre, form_post, form_namerica, form_europe, form_yessan,
form_nosan, file = "R/bayesian_clean.RData")
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data and analysis results
mortality <- read.csv("data/mortality_data.csv")
load('R/bayesian_raw.RData')
load('R/bayesian_clean.RData')
#### Table of Main Results -----------------------------------------------------
#Combining raw tables from results lists
raw_tab <- bind_rows(form_comb$param, form_pre$param, form_post$param,
form_namerica$param, form_europe$param, form_yessan$param,
form_nosan$param)
#Extracting the survival probabilities
pred1_tab <- raw_tab %>%
filter(value == "pred1") %>%
mutate(`1-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `1-Year Survival (95% CI)`)
pred5_tab <- raw_tab %>%
filter(value == "pred5") %>%
mutate(`5-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `5-Year Survival (95% CI)`)
pred10_tab <- raw_tab %>%
filter(value == "pred10") %>%
mutate(`10-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `10-Year Survival (95% CI)`)
#Extracting median survival
med_tab <- raw_tab %>%
filter(value == "median") %>%
mutate(`Median Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `Median Survival (95% CI)`)
#Extracting the distribution parameters
sdlog <- raw_tab %>%
filter(value == "sdlog") %>%
select(label, sdlog = est)
dist_tab <- raw_tab %>%
filter(value == "meanlog") %>%
full_join(sdlog, by = "label") %>%
mutate(`Survival Distribution` = paste0("lognormal(", round(est, 2), ", ",
round(sdlog, 2), ")")) %>%
select(label, `Survival Distribution`)
data_comb2 <- as.data.frame(t(data_comb[[2]]))
data_comb2$label <- "Combined"
data_pre2 <- as.data.frame(t(data_pre[[2]]))
data_pre2$label <- "Pre-1930"
data_post2 <- as.data.frame(t(data_post[[2]]))
data_post2$label <- "Post-1930"
data_namerica2 <- as.data.frame(t(data_namerica[[2]]))
data_namerica2$label <- "North America"
data_europe2 <- as.data.frame(t(data_europe[[2]]))
data_europe2$label <- "Europe"
data_yessan2 <- as.data.frame(t(data_yessan[[2]]))
data_yessan2$label <- "Sanatorium/hospital"
data_nosan2 <- as.data.frame(t(data_nosan[[2]]))
data_nosan2$label <- "Non-Sanatorium"
View(data_comb2)
table(mortality$study_id)
table(mortality$first_author)
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program transforms the life-table study data extracted from the
# publications and transforms it into individual-level data
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
## Reading in all of the datasets
dataList <- read_excel_allsheets("data/pre_chemo_data.xlsx")
dataList$`Data dictionary` <- NULL
## Reading in study information
studyid <- read.csv("data/study_id.csv")
#### Overall counts -------------------------------------------------------------------------------
#Removing the severity data for 75_23 because it is the same people as the full study data in 75_1023
countList <- dataList[!names(dataList) %in% c("79_1023_sev")]
pull_first_row <- function(paper){
first_row <- paper %>%
group_by(cohort_id) %>%
arrange(interval_l) %>%
select(study_id, paper_id, cohort_id, n, c1a, c2) %>%
mutate(paper_id = as.character(paper_id),
study_id = as.character(study_id)) %>%
slice(1)
return(first_row)
}
cohorts <- map_dfr(countList, pull_first_row)
#Number of papers
length(unique(cohorts$paper_id))
#Number of studies
length(unique(cohorts$study_id))
#Number of cohorts
length(unique(cohorts$cohort_id))
#Number of patients
sum(cohorts$n)
12/18
53/18
53/84
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data and analysis results
mortality <- read.csv("data/mortality_data.csv")
load('R/bayesian_raw.RData')
load('R/bayesian_clean.RData')
#### Table of Main Results -----------------------------------------------------
#Combining raw tables from results lists
raw_tab <- bind_rows(form_comb$param, form_pre$param, form_post$param,
form_namerica$param, form_europe$param, form_yessan$param,
form_nosan$param)
#Extracting the survival probabilities
pred1_tab <- raw_tab %>%
filter(value == "pred1") %>%
mutate(`1-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `1-Year Survival (95% CI)`)
pred5_tab <- raw_tab %>%
filter(value == "pred5") %>%
mutate(`5-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `5-Year Survival (95% CI)`)
pred10_tab <- raw_tab %>%
filter(value == "pred10") %>%
mutate(`10-Year Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `10-Year Survival (95% CI)`)
#Extracting median survival
med_tab <- raw_tab %>%
filter(value == "median") %>%
mutate(`Median Survival (95% CI)` = paste0(round(est, 2), " (",
round(cilb, 2), ", ",
round(ciub, 2), ")")) %>%
select(label, `Median Survival (95% CI)`)
#Extracting the distribution parameters
sdlog <- raw_tab %>%
filter(value == "sdlog") %>%
select(label, sdlog = est)
dist_tab <- raw_tab %>%
filter(value == "meanlog") %>%
full_join(sdlog, by = "label") %>%
mutate(`Survival Distribution` = paste0("lognormal(", round(est, 2), ", ",
round(sdlog, 2), ")")) %>%
select(label, `Survival Distribution`)
# Finding number of papers, cohorts, individuals
data_comb2 <- as.data.frame(t(data_comb[[2]]))
data_comb2$label <- "Combined"
data_pre2 <- as.data.frame(t(data_pre[[2]]))
data_pre2$label <- "Pre-1930"
data_post2 <- as.data.frame(t(data_post[[2]]))
data_post2$label <- "Post-1930"
data_namerica2 <- as.data.frame(t(data_namerica[[2]]))
data_namerica2$label <- "North America"
data_europe2 <- as.data.frame(t(data_europe[[2]]))
data_europe2$label <- "Europe"
data_yessan2 <- as.data.frame(t(data_yessan[[2]]))
data_yessan2$label <- "Sanatorium/hospital"
data_nosan2 <- as.data.frame(t(data_nosan[[2]]))
data_nosan2$label <- "Non-Sanatorium"
counts <- bind_rows(data_comb2, data_pre2, data_post2, data_namerica2,
data_europe2, data_yessan2, data_nosan2) %>%
select(label, `Number of Studies` = nStudies,
`Number of Cohorts` = nCohorts,
`Number of Individuals` = nIndividuals)
#Combining the tables
final_tab <- dist_tab %>%
full_join(pred1_tab, by = c("label")) %>%
full_join(pred5_tab, by = c("label")) %>%
full_join(pred10_tab, by = c("label")) %>%
full_join(med_tab, by = c("label")) %>%
full_join(counts, by = c("label"))
View(final_tab)
#Combining the tables
final_tab <- dist_tab %>%
full_join(pred1_tab, by = c("label")) %>%
full_join(pred5_tab, by = c("label")) %>%
full_join(pred10_tab, by = c("label")) %>%
full_join(med_tab, by = c("label")) %>%
full_join(counts, by = c("label"))
View(final_tab)
#Combining the tables
final_tab <- dist_tab %>%
full_join(pred1_tab, by = c("label")) %>%
full_join(pred5_tab, by = c("label")) %>%
full_join(pred10_tab, by = c("label")) %>%
full_join(med_tab, by = c("label")) %>%
full_join(counts, by = c("label"))
View(final_tab)
#Combining the tables
final_tab <- dist_tab %>%
full_join(pred1_tab, by = c("label")) %>%
full_join(pred5_tab, by = c("label")) %>%
full_join(pred10_tab, by = c("label")) %>%
full_join(med_tab, by = c("label")) %>%
full_join(counts, by = c("label"))
View(final_tab)
#Variance of frailty terms
theta <- raw_tab %>%
filter(value == "theta") %>%
mutate(theta = round(est, 2)) %>%
select(label, theta)
View(theta)
write.csv(final_tab, "data\mortality_results_table.csv")
write.csv(final_tab, "data/mortality_results_table.csv")
View(studyid)
View(studyid %>% filter(study_id %in% mortality$study_id))
theta
View(theta)
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data and analysis results
mortality <- read.csv("data/mortality_data.csv")
load('R/bayesian_clean.RData')
load("R/bayesian_comp.RData")
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data and analysis results
mortality <- read.csv("data/mortality_data.csv")
load('R/bayesian_clean.RData')
#### Survival Curves: Combined -------------------------------------------------
ggplot(form_comp$surv_dens) +
geom_line(aes(x = x, y = surv), color = "black", size = 1,
linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.25, na.rm = TRUE) +
geom_line(data = form_comp$ind_surv, aes(x = x, y = surv, group = study_id),
size = 0.7, alpha = 0.2) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
#Sarah V. Leavitt
#Boston University
#Pre-chemotherapy TB Analysis
##############################################################################
# This program creates figures and tables of the mortality analysis results
##############################################################################
options(scipen=999)
options(digits = 10)
rm(list = ls())
source("R/utils.R")
reload_source()
#Reading in the study_id correspondence table
studyid <- read.csv("data/study_id.csv")
#Reading in individual mortality data and analysis results
mortality <- read.csv("data/mortality_data.csv")
load('R/bayesian_clean.RData')
#### Survival Curves: Combined -------------------------------------------------
ggplot(form_comb$surv_dens) +
geom_line(aes(x = x, y = surv), color = "black", size = 1,
linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.25, na.rm = TRUE) +
geom_line(data = form_comb$ind_surv, aes(x = x, y = surv, group = study_id),
size = 0.7, alpha = 0.2) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
ggsave("Figures/survival_curve_all.png", width = 6, height = 5.5)
#### Survival Curves: Stratified -----------------------------------------------
plot_surv_strata <- function(data1, data2){
p <- ggplot(bind_rows(data1$surv_dens, data2$surv_dens)) +
geom_line(aes(x = x, y = surv),
color = "black", size = 1, linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.4) +
facet_wrap(~label, nrow = 2) +
geom_line(data = bind_rows(data1$ind_surv, data2$ind_surv),
aes(x = x, y = surv, group = study_id),
size = 1, alpha = 0.3) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
}
surv_time <- plot_surv_strata(form_pre, form_post)
ggsave("Figures/survival_curve_time.png", surv_time, width = 5, height = 7)
p <- ggplot(bind_rows(data1$surv_dens, data2$surv_dens)) +
geom_line(aes(x = x, y = surv),
color = "black", size = 1, linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.4) +
facet_wrap(~label, nrow = 2) +
geom_line(data = bind_rows(data1$ind_surv, data2$ind_surv),
aes(x = x, y = surv, group = study_id),
size = 0.75, alpha = 0.3) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
plot_surv_strata <- function(data1, data2){
p <- ggplot(bind_rows(data1$surv_dens, data2$surv_dens)) +
geom_line(aes(x = x, y = surv),
color = "black", size = 1, linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.4) +
facet_wrap(~label, nrow = 2) +
geom_line(data = bind_rows(data1$ind_surv, data2$ind_surv),
aes(x = x, y = surv, group = study_id),
size = 0.75, alpha = 0.3) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
}
surv_time <- plot_surv_strata(form_pre, form_post)
ggsave("Figures/survival_curve_time.png", surv_time, width = 5, height = 7)
ggsave("Figures/survival_curve_time.png", surv_time, width = 4, height = 6)
plot_surv_strata <- function(data1, data2){
p <- ggplot(bind_rows(data1$surv_dens, data2$surv_dens)) +
geom_line(aes(x = x, y = surv),
color = "black", size = 1, linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.4) +
facet_wrap(~label, nrow = 2) +
geom_line(data = bind_rows(data1$ind_surv, data2$ind_surv),
aes(x = x, y = surv, group = study_id),
size = 0.7, alpha = 0.2) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
}
surv_time <- plot_surv_strata(form_pre, form_post)
ggsave("Figures/survival_curve_time.png", surv_time, width = 4.5, height = 6)
plot_surv_strata <- function(data1, data2){
p <- ggplot(bind_rows(data1$surv_dens, data2$surv_dens)) +
geom_line(aes(x = x, y = surv),
color = "black", size = 1, linetype = "longdash") +
geom_smooth(aes(x = x, y = surv_est, ymin = cilb, ymax = ciub),
stat = "identity", linetype = 0, alpha = 0.4) +
facet_wrap(~label, nrow = 2) +
geom_line(data = bind_rows(data1$ind_surv, data2$ind_surv),
aes(x = x, y = surv, group = study_id),
size = 0.6, alpha = 0.2) +
scale_y_continuous(name = "Survival, 1 - F(t)", limits = c(0, 1)) +
scale_x_continuous(name = "Years", limits = c(0, 30)) +
theme_bw()
}
surv_time <- plot_surv_strata(form_pre, form_post)
ggsave("Figures/survival_curve_time.png", surv_time, width = 4.5, height = 6)
surv_loc <- plot_surv_strata(form_namerica, form_europe)
ggsave("Figures/survival_curve_location.png", surv_loc, width = 4.5, height = 6)
surv_san <- plot_surv_strata(form_yessan, form_nosan)
ggsave("Figures/survival_curve_sanatorium.png", surv_san, width = 4.5, height = 6)
